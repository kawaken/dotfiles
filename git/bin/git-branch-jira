#!/usr/bin/env bash

# JIRAタイトル付きでブランチ一覧を表示するgitサブコマンド

set -euo pipefail

# JIRAデータファイルのパス
JIRA_DATA_FILE="${XDG_DATA_HOME:-$HOME/.local/share}/jira-sync/current_sprint_issues.json"

# ブランチ名からJIRAタイトルを取得する関数
get_jira_title() {
    local branch="$1"
    
    # JSONファイルが存在しない場合は空文字を返す
    if [[ ! -f "$JIRA_DATA_FILE" ]]; then
        echo ""
        return
    fi
    
    # jqでJSONからタイトルを取得
    local title=$(jq -r ".[] | select(.key == \"$branch\") | .fields.summary // empty" "$JIRA_DATA_FILE" 2>/dev/null)
    
    if [[ -n "$title" && "$title" != "null" ]]; then
        echo "$title"
    else
        echo ""
    fi
}

# git branchの出力を配列で取得
mapfile -t lines < <(git branch "$@")

# 各行を処理
for line in "${lines[@]}"; do
    # プレフィックス（*, +, 空白2つ）とブランチ名を分離
    prefix="${line:0:2}"
    branch="${line:2}"
    
    # JIRAタイトルを取得
    title=$(get_jira_title "$branch")
    
    if [[ -n "$title" ]]; then
        printf "%s%s (%s)\n" "$prefix" "$branch" "$title"
    else
        printf "%s\n" "$line"
    fi
done