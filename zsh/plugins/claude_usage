#!/usr/bin/env zsh
# Claude Code Usage Plugin
# claudeã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¾Œã«ccusageã§ä½¿ç”¨çŠ¶æ³ã‚’è¡¨ç¤ºã™ã‚‹

# ccusageã‚³ãƒãƒ³ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if ! command -v ccusage &> /dev/null; then
    return 0
fi

# ä½¿ç”¨çŠ¶æ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
_claude_show_usage() {
    # ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆYYYYMMDDå½¢å¼ï¼‰
    local today=$(date +%Y%m%d)
    
    # ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    local today_json=$(ccusage daily --json --since $today --until $today 2>/dev/null)
    if [[ -z "$today_json" ]]; then
        return 0
    fi
    
    # ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    local month_json=$(ccusage monthly --json 2>/dev/null)
    if [[ -z "$month_json" ]]; then
        return 0
    fi
    
    # ä»Šæ—¥ã®ã‚³ã‚¹ãƒˆã‚’å–å¾—
    local today_cost=$(echo "$today_json" | jq -r '.totals.totalCost // 0' 2>/dev/null)
    
    # ä»Šæœˆã®ã‚³ã‚¹ãƒˆã‚’å–å¾—ï¼ˆç¾åœ¨ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ï¼‰
    local current_month=$(date +%Y-%m)
    local month_cost=$(echo "$month_json" | jq -r --arg month "$current_month" '
        .monthly[] 
        | select(.month == $month) 
        | .totalCost // 0
    ' 2>/dev/null)
    
    # çµæœã‚’è¡¨ç¤º
    if [[ -n "$today_cost" && -n "$month_cost" ]]; then
        echo ""
        echo "ğŸ“Š Claude Code Usage:"
        printf "  Today:       $%.2f USD\n" "$today_cost"
        printf "  This month:  $%.2f USD\n" "$month_cost"
    fi
}

# precmdãƒ•ãƒƒã‚¯ã§å‰ã®ã‚³ãƒãƒ³ãƒ‰ãŒclaudeã ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
_claude_precmd_hook() {
    if [[ "$_claude_last_cmd" == "claude"* ]] || [[ "$_claude_last_cmd" == "cl"* ]]; then
        _claude_show_usage
    fi
    _claude_last_cmd=""
}

# preexecãƒ•ãƒƒã‚¯ã§ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜éŒ²
_claude_preexec_hook() {
    local cmd="${1:-$2}"
    _claude_last_cmd="$cmd"
}

# ãƒ•ãƒƒã‚¯é–¢æ•°ã‚’ç™»éŒ²
autoload -Uz add-zsh-hook
add-zsh-hook precmd _claude_precmd_hook
add-zsh-hook preexec _claude_preexec_hook
